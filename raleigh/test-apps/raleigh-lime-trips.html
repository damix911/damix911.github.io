<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Integration with Deck.GL</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.12/esri/themes/light/main.css"/>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script src="https://js.arcgis.com/4.12/"></script>
    <script src="../lib/esri-deck.js"></script>

    <script>
      require([
          "esri/Map",
          "esri/views/MapView",
          "esri/geometry/support/webMercatorUtils",
          "esri/symbols/SimpleMarkerSymbol",
          "esri/Graphic"
        ], function(
          Map,
          MapView,
          webMercatorUtils,
          SimpleMarkerSymbol,
          Graphic
        ) {          
          var map = new Map({
            // basemap: "streets",
            basemap: "streets-night-vector"
          });
          
          var view = new MapView({
            container: "viewDiv",
            map: map,
            // center: [-78.6382, 35.7796],
            center: [-78.6628949825737, 35.79226756975966],
            zoom: 12
          });
          
          var sms = new SimpleMarkerSymbol({
            size: "10px",
            style: "circle",
            color: "red",
            outline: {
              color: "white",
              width: "1px"
            }
          });

          // Load the data and wait for esriDeck to be ready. In the future
          // we would like for esriDeck to become an AMD module and be ready
          // immediately.
          Promise.all([
            fetch("./raleigh-lime-trips.json").then(response => response.json()),
            esriDeck.ready
          ]).then((results) => {
            // Prepare data for the deck.gl layer
            const start = performance.now();

            var data = [];

            // results[0].features = [results[0].features[0]];
            for (var i = 0; i < results[0].features.length; ++i) {
              var trip = results[0].features[i];
              // console.log(trip);
              // trip.geometry.paths = [trip.geometry.paths[0], trip.geometry.paths[1]];
              // console.log(trip.geometry.paths);

              for (const path of trip.geometry.paths) {
                data.push({
                  vendor: 1,
                  waypoints: path.map(function (s, i) {
                    const lngLat = webMercatorUtils.xyToLngLat(s[0], s[1]);
                    
                    // var g = new Graphic({
                    //   symbol: sms,
                    //   geometry: {
                    //     type: "point",
                    //     x: lngLat[0],
                    //     y: lngLat[1]
                    //   }
                    // });

                    // view.graphics.add(g);
                    
                    // console.log(lngLat);
                    return { coordinates: lngLat, timestamp: i * 1000 };
                  })
                });
              }
            }

            const tripsLayerData = {
              data,
              getPath: d => d.waypoints.map(p => p.coordinates),
              getTimestamps: d => d.waypoints.map(p => p.timestamp),
              getColor: d => d.vendor === 0 ? [255, 255, 0] : [0, 255, 0],
              opacity: 1,
              widthMinPixels: 2,
              rounded: false,
              trailLength: 2000,
              currentTime: 0
            };

            // Convert to an Esri layer
            const layer = new esriDeck.EsriDeckLayer({
              getDeckLayer() {
                return new esriDeck.layers.TripsLayer({...tripsLayerData, id: "Trips Layer", currentTime: performance.now() - start});
              }
            });

            // Add layer to the map
            map.layers.add(layer);

            setInterval(() => {
              layer.redraw();
            }, 50);
          });
        }
      )
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
