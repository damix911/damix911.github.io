<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Integration with Deck.GL</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.12/esri/themes/light/main.css"/>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script src="https://js.arcgis.com/4.12/"></script>
    <script src="../lib/esri-deck.js"></script>

    <script>
      require([
          "esri/Map",
          "esri/views/MapView"
        ], function(
          Map,
          MapView
        ) {
          fetch("./trips.json").then(function (response) { return response.json(); }).then(function (tripsJson) {
            var data = [];
            
            for (var i = 0; i < tripsJson.length; ++i) {
              var trip = tripsJson[i];
              data.push({
                vendor: trip.vendor,
                waypoints: trip.segments.map(function (s, i) {
                  return { coordinates: [s[0], s[1]], timestamp: 1554772579000 + i * 1000 };
                })
              });
            }

            const start = performance.now();

            const tripsLayerData = {
              data: data || [
                {
                  waypoints: [
                    { coordinates: [-74.50, 40], timestamp: 1554772579000 },
                    { coordinates: [-68, 40], timestamp: 1554772579000 + 10000 },
                    { coordinates: [-68, 36], timestamp: 1554772579000 + 20000 }
                  ],
                }
              ],
              getPath: d => d.waypoints.map(p => p.coordinates),
              getTimestamps: d => d.waypoints.map(p => p.timestamp - 1554772579000),
              getColor: d => d.vendor === 0 ? [255, 255, 0] : [0, 255, 0],
              opacity: 1,
              widthMinPixels: 2,
              rounded: false,
              trailLength: 20000,
              currentTime: 20000
            };
            
            function getDeckLayer() {
              return new esriDeck.layers.TripsLayer({...tripsLayerData, id: "Trips Layer #1", currentTime: performance.now() - start});
            }

            esriDeck.createLayer(getDeckLayer)
            .then(function (layer) {
              var map = new Map({
                // basemap: "streets-night-vector",
                basemap: "streets-vector",
                // basemap: "streets",
                layers: [layer]
              });

              var view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-74.0060, 40.7128],
                zoom: 14
              });

              setTimeout(() => {
                console.log("layer.deck", layer.deck);
              }, 5000);
            });
          });
        }
      )
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
