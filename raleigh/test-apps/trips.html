<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Integration with Deck.GL</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.12/esri/themes/light/main.css"/>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script src="https://js.arcgis.com/4.12/"></script>
    <script src="../lib/esri-deck.js"></script>

    <script>
      require([
          "esri/Map",
          "esri/views/MapView"
        ], function(
          Map,
          MapView
        ) {          
          var map = new Map({
            // basemap: "streets",
            basemap: "streets-night-vector"
          });
          
          var view = new MapView({
            container: "viewDiv",
            map: map,
            center: [-74.0060, 40.7128],
            zoom: 14
          });
          
          // Load the data and wait for esriDeck to be ready. In the future
          // we would like for esriDeck to become an AMD module and be ready
          // immediately.
          Promise.all([
            fetch("./trips.json").then(response => response.json()),
            esriDeck.ready
          ]).then((results) => {
            // Prepare data for the deck.gl layer
            const start = performance.now();

            var data = [];

            for (var i = 0; i < results[0].length; ++i) {
              var trip = results[0][i];
              data.push({
                vendor: trip.vendor,
                waypoints: trip.segments.map(function (s, i) {
                  return { coordinates: [s[0], s[1]], timestamp: i * 1000 };
                })
              });
            }

            const tripsLayerData = {
              data,
              getPath: d => d.waypoints.map(p => p.coordinates),
              getTimestamps: d => d.waypoints.map(p => p.timestamp),
              getColor: d => d.vendor === 0 ? [255, 255, 0] : [0, 255, 0],
              opacity: 1,
              widthMinPixels: 2,
              rounded: false,
              trailLength: 2000,
              currentTime: 0
            };

            // Convert to an Esri layer
            const layer = new esriDeck.EsriDeckLayer({
              getDeckLayer() {
                return new esriDeck.layers.TripsLayer({...tripsLayerData, id: "Trips Layer", currentTime: performance.now() - start});
              }
            });

            // Add layer to the map
            map.layers.add(layer);

            setInterval(() => {
              layer.redraw();
            }, 50);
          });
        }
      )
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
